# **ch.5 애그리게잇과 전술적 설계**

![5.topic](/img/5.topic.png)

이번 장에서는 2개의 바운디드 컨텍스트를 가지고 이야기한다.

- 1: 애자일 프로젝트 관리 컨텍스트 라는 이름의 **핵심도메인**
- 2: 다른 컨텍스트 매핑 통합 기반의 협업 도구를 제공하는 **지원 서브 도메인** 

각각의 도메인 안에 애그리게잇들은 다음과 같다.

- `Product`
- `BacklogItem`
- `Release`
- `Sprint`
- `Forum`
- `Discussion`
- `Post`
- `Calendar`
- `CalendarEntry`

*Discussion은 **값 객체(Value Object)** 이다.*

<br>

![aggregate](/img/aggregate.png)

각 **애그리게잇** 은 1개 이상의 엔터티로 구성되고, 그 중 한 **엔터티** 는 **애그리게잇 루트** 라고 부른다.

- **애그리게잇** 은 그 구성에 **값 객체**를 포함할 수 있다.
- 각 **애그리게잇**의 **루트 엔터티**는 **애그리게잇** 안의 다른 모든 요소를 소유한다.
- **애그리게잇** 은 개념적으로 완전하게 모델링해야 한다.
- 각 **애그리게잇** 은 일관성 있는 트랜잭션 경계를 형성한다.
- 한 **애그리게잇** 내의 모든 구성 요소는 반드시 비즈니스 규칙을 따르면서 일관성 있게 처리 되어야 한다.(애그리게잇 내에 트랜잭션 이후 일관성이 지켜질 필요가 없는 다른 요소를 포함해서는 안된다는 것은 아니다.)



<br>

**엔터티(Entity)** 란 같은 형태를 띄거나 다른 형태의 **엔터티** 들과의 특성을 구별할 수 있는 고유한 식별성을 갖는 것을 말한다.

- **엔터티**는 변할 수 있다.(항상 그 상태는 계속해서 변할 수 있음을 명심한다.)
- **엔터티**를 구분해주는 주 요인은 독립성에 있다.
- **루트 엔터티**의 명칭은 **애그리게잇**의 개념적 명칭으로, **애그리게잇** 이 모델링 하는 개념적 완전성을 적절하게 표현할 수 있는 것으로 지정한다.

<br>

**값 객체(Value Object)** 란 불변의 개념적 완전성을 모델링 한다.

- 모델에서 **값** 은 그말 그대로 값을 의마한다.
- **엔터티** 와 달리 고유한 식별성이 없으며, 값 형태로 캡슐화된 속성을 비교함으로써 동일함이 결정된다.
- **값 객체** 가 어떤 것을 나타낸다기 보다, **엔터티**를 서술하고, 수량화 하거나 측정하는데 사용된다.

<br>


애플리케이션에 대한 트랜잭션의 사용은 어느 정도 구현에 관한 세부 사항이다. 트랜잭션이란 애그리게잇에 대한 변경을 독립시키고, 소프트웨어가 언제나 충실히 준수해야 하는 규칙인 비즈니스 불변성을 각 비즈니스 오퍼레이션에 맞게 일관성을 보장한다.

- 액터 모델과 같은 다른 아키텍처 활용 사례에서는 각 애그리게잇을 액터로 구현하고, 트랜잭션은 데이터베이스에 대한 원자적(ATOMIC) 트랜잭션을 지원하지 않는 **이벤트 소싱** 을 사용한다.
- **애그리게잇** 의 상태나 이벤트 소싱은 항상 안전하고 정확하게 트랜잭션으로 처리하고 관리해야 한다.
- **애그리게잇** 이 완전하고 유효한 상태로 저장되지 않는다면, 수행된 비즈니스 오퍼레이션은 비즈니스 규칙에 어긋난것으로 간주한다.

<br>

**애그리게잇** 은 별로 분리된 트랜잭션으로 수정, 커밋된다. 이러한 이유로 애그리게잇을 트랜잭션의 일관성을 만드는 경계라고 부른다.

- **애그리게잇** 구성 요소들은 트랜잭션의 일관성과 성공을 보장하도록 설계해야한다.
- 예를 들어, "애그리게잇 형태1" 인스턴스는 "애그리게잇 형태2" 인스턴스로 부터 분리된 트랜잭션으로 제어되어야 한다.

<br>

<br><hr><hr>

## **애그리게잇 경험 법칙**

효과적으로 동작하는 애그리게잇을 설계하는데 도움을 줄 수 있는 애그리게잇 설계의 기본 규칙은 다음과 같다.

1. **애그리게잇 경계 내에서 비즈니스 불변사항들을 보호하라.**
2. **작은 애그리게잇을 설계하라.**
3. **오직 ID를 통해 다른 애그리게잇을 참고하라.**
4. **결과적 일관성을 사용해 다른 애그리게잇을 갱신하라**

<br>

> ### **규칙 1: 애그리게잇 경계 내의 비즈니스 불변사항을 보호하라**

![agrregateRule](/img/agrregateRule.png)

규칙 1은 트랜잭션이 커밋될 때 비즈니스의 일관성이 지켜지는 것에 기반을 두고 애그리게잇 구성요소를 결정해야한다는 것을 의미한다.

- Product 는 트랜잭션의 끝에 ProductBacklogItem 인스턴스로 구성되는 모든 것이 반드시 Product의 루트와 일관되게 처리되도록 설계한다.
- Sprint 는 트랜잭션의 끝에 CommitedBacklogItem 인스턴스로 구성되는 모든 것이 반드시 Sprint 루트와 일관되게 처리하도록 설계한다.

<br>

![agrregateRule1](/img/agrregateRule1.png)

BacklogItem의 애그리게잇을 예시로 설명한다.

- Task(작업) 인스턴스의 hoursRemaining(남은시간)이 0일 때, BackligItem의 Status(상태)는 반드시 DONE(완료)으로 설정해야한다는 비즈니스 규칙이 존재한다.
- 이는 트랜잭션 후 반드시 부합되어야 하는 매우 명확한 비즈니스 불변사항을 의미하낟.

<br>
