# 아카이빙
## 요약
- 백업을 제대로 하지 않으면 아침에 봉변을 당할 수 있다.
    - 중요한데이터를 모두 백업 할 수 있도록 자동화되고 신뢰성 있으며 검증되고 안전하게 반복되는 절차를 만든다.
    - 가능하면 기밀 데이터는 별도의 파티션에 만든 파일 시스템에 저장하고, 시스템 부팅 시 이 파일 시스템을 마운트 한다.
    - 파일 접근 권한이 정확한지 늘 검사하고, 최소한의 권한만 부여한다.


- `tar` 명령어는 일반적으로 파일 시스템 전체나 일부분을 아카이빙하는데 사용하지만, `dd` 는 파티션 이미지를 만드는데 더 적합하다.
- 아카이브를 압축하면 저장 장치에서 차지 할 공간을 줄여 줄 뿐 아니라 전송에 필요한 네트워크 대역폭도 줄여준다.
- 의사 파일 시스템을 담고 있는 디렉터리는 백업 할 필요가 없다.
- 아카이브를 전송하는 명령을 아카이브를 생성하는 명령에 포함 할 수도 있고, 옵션을 잘 사용하면 아카이브를 로컬에 저장하지 않아도 된다.
- 아카이브에서 복원된 개체의 접근 권한과 소유권 속성은 보존해야 한다.
- `dd` 를 사용하면 (상당히) 안전하게 디스크를 소거 할 수 있다.
- `rsync` 로 아카이브를 점진적으로 동기화 할 수 있으며, 지속해서 백업을 수행할 때 드는 시간과 네트워크 리소스를 상당히 절감한다.


<br><hr><br>

## 핵심용어

- `아카이브(archaive)` 는 파일시스템 개체를 하나로 묶는 특별한 형식의 파일이다.
- `압축(compression)` 은 압축 알고리즘 사용한 도구로 파일이 사용하는 디스크 공간을 줄이는 과정이다.
- `이미지(image)` 는 새롱누 곳에 원본 파일 시스템을 다시 생성하는데 필요한 디렉터리와 파일을 담은 아카이브이다.
- `권한(permission)` 은 개체를 누가 어떻게 사용할지 결정할 수 있게 개체에 할당된 속성이다.
- `소유권(ownership)` 은 개체에 대한 권한을 가진 소유자 그룹이다.
- `그룹(group)` 은 여러 사용자에 대한 권한을 관리할 때 사용하는 계정이다.

<br><hr><br>


## 세부사항

<br>

> **아카이브(archive)**
- 여러 파일과 디렉터리를 담고 있는 하나의 파일로, 아카이브를 생성하고 나면 파일들을 관리하고 추적하기기 쉬워진다.
- 믿을 만한 파일 시스템 이미지를 만들고 효율적으로 데이터를 백업하는데 아카이브가 사용된다.

- 쉽게 공유하거나 백업을 위해 디렉터리와 그 안에 들어 있는 파일들의 사본을 만들 때에는 `tar` 이 좋다.
- 파티션 혹은 하드디스크를 통채로 복사해야한다면 `dd` 명령을 사용하는 것이 좋다.
- 주기적으로 시스템을 백업할 때에는 `rsync` 를 사용하면 좋다.

- 실제 파일 시스템과 `의사 파일 시스템` 을 구분해야한다.
    - `의사파일 시스템`
        - 디스크에 저장되지 않고 메모리에만 존재하며 시스템이 종료될 때 삭제된다.
        - 파일 시스템 유형은 `tmpfs` 혹은 `Used` 열의 크기가 0 이다.

<br>

- 특정 디스크를 백업할 때는 어느 파티션을 백업하고, 어느 파티션을 백업하지 않을지 정보를 충분히 입수하고 나서 결정해야 한다. 

<br>

> **백업을 위해 만족해야하는 속성**
- `신뢰성(reliable)`: 백업 중에 무결성을 충분히 보장 할 수 있는 스토리지 매체를 사용한다.
- `검증(tested)`: 실운영 환경과 똑같은 환경에서 될 수 있으면 많은 아카이브로 복수 테스트를 수행한다.
- `순환(rotated)`: 현재 백업보다 최소 몇 단계 이전까지의 아카이브를 모두 보관해 최신 백업으로 복구 할 수 없을 때를 대비한다.
- `분산(distributed)`: 화재나 재해가 발생할 때를 대비하여 일부 아카이브는 물리적으로 떨어진 곳에 저장한다.
- `보안(secure)`: 백업 및 복구 과정 동안 안전하지 않은 네트워크나 저장소에 데이터를 잠시라도 노출시켜서는 안된다.
- `준수(compliant)`: 관련 법규와 업계 표준을 준수한다.
- `최신(up to date)`: 몇 주 또는 몇 달이 지난 아카이브는 삭제하고 최신의 아카이브를 보관한다.
- `스크립트(scripted)`: 수행할 작업은 자동화한다.
    

<br>

> **압축(compression)**
*파일이나 아카이브가 디스크에서 차지하는 공간을 줄여는 알고리즘을 적용한 소프트웨어 도구*
- `tar [OPTION] [NAME TO BE CREATED]`
    - `tar cvf archivename.tar *` or `tar czvf archivename.tar *.mp4`
        - `c`: 아카이브를 새로 만든다.
        - `v`: 자세한 메세지를 화면에 출력한다.
        - `f`: 생성할 아카이브 파일명을 가리킨다.
        - `z`: 아카이브를 `gzip` 프로그램으로 압축한다. 관례에 따라 `.tar` 뒤에 `.gz` 확장자를 덧 붙인다.
        
        - `*.mp4`: `.mp4` 확장자를 사용하는 파일들을 아카이빙한다.



    <br>

    - `tar` 은 명시한 원본 디렉토리와 파일들을 절대 이동시키거나 삭제하지 않는다.
    - `*` 대신 `.(점)` 을 사용하면 숨김파일도 아카이브에 들어가므로 주의한다.
    - 현재 작업 디렉터리 외부에 있는 파일과 디렉터리 또한 대상으로 선택 할 수 있다.

- 파일 분할 하기
    - `split [OPTION] [TARGET FILE] [NAME TO BE CREATED]`
        - `split -b 1G archivename.tar.gz "archivename.tar.gz.part"`
        - `-b`: 생성된 아카이브 파일을 1GB 크기의 조각들로 나눈다. 
        - 생성되는 파일은 `archivename.tar.gz.parta`, `archivename.tar.gz.partb`, `archivename.tar.gz.partc` 으로 생성된다.

<br>

- 파일 합치기
    - `cat [TARGET FILES] > [NAME TO BE CREATED]`
    - `cat archivename.tar.gz.part* > archivename.tar.gz`


<br>

> **파일 시스템 아카이브 스트리밍**

*[**경험필요**] 작동중인 리눅스 컴퓨터에서 아카이브 이미지를 생성해 원격 저장소에 스트리밍하는 방식*
- `tar czvf - --one-file-system \
/ /usr /var \
--exclude=/home/andy/ | ssh username@IP \
"cat > /home/username/workstation-backup-Oct-2.tar.gz"`
    - `--one-file-system`: 아카이브를 만들 때 다른 파티션에 있는 데이터를 제외한다.
    - `/ /usr /var \`" `usr` 과 `var` 파티션을 명시적으로 참조한다.
    - `--exclude=/home/andy/`: 필요에 따라 선택된 파일 시스템 안에서 특정 디렉토리 파일이나 파일을 제외한다.

<br>

- 예시: `tar czvf - importantstuff | ssh username@10.0.3.141 <linearrow /> "cat > /home/username/myfiles.tar.gz"`
    > **순서**
    1. `importantstuff` 디렉토리를 아카이브 생성한다.
    2. `-`: 내용을 표준 출력 장치(화면)에 출력한다. 
    3. 추가할 파일명을 tar 명령 끝에서 지정한다.
    4. 이름이 지정되지 않은, 압축된 아카이브를 원격 서버에 로그인하는 ssh 명령과 파이프 라인으로 연결한다.
        - 로그인 패스워드를 묻는다.
    5. 이 후 큰따옴표 안의 명령이 원격 서버에서 실행된다.
        - cat 명령은 파이프로 전달받은 데이터 스트림을 원격 서버의 홈 디렉토리에 myfiles.tar.gz 의 파일의 내용으로 저장한다.

<br>

*다른 컴퓨터에 리눅스 파일 시스템이 설치되어 있지 않으면 이 명령을 제대로 수행 할 수 없다. 이럴 경우 `dd` 명령을 사용한다.*


<br>

